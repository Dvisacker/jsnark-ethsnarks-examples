version: 2
jobs:
  build_jsnark_circuit_builder:
    docker:
      - image: circleci/openjdk:8-jdk-browsers
    steps:
      - checkout
      - run:
          name: Get jsnark
          command: git submodule update --init --recursive jsnark
      - run:
          name: Install JsnarkCircuitBuilder dependencies
          command: |
            sudo apt-get install junit4
            cd jsnark/JsnarkCircuitBuilder
            wget https://www.bouncycastle.org/download/bcprov-jdk15on-159.jar
      - run:
          name: Build JsnarkCircuitBuilder
          command: |
            cd jsnark/JsnarkCircuitBuilder
            mkdir -p bin
            javac -d bin -cp /usr/share/java/junit4.jar:bcprov-jdk15on-159.jar  $(find ./src/* | grep ".java$")
      - persist_to_workspace:
          root: jsnark/JsnarkCircuitBuilder
          paths:
            - bin
            - config.properties

  build_jsnark_libsnark:
    docker:
      - image: appliedblockchain/libsnark-env
    steps:
      - checkout
      - run:
          name: Get jsnark
          command: git submodule update --init --recursive jsnark
      - run:
          name: Prepare depends
          command: |
            cd jsnark/libsnark
            ./prepare-depends.sh
      - run:
          name: make
          command: |
            cd jsnark/libsnark
            make
      - persist_to_workspace:
          root: jsnark
          paths:
            - libsnark

  build_ethsnarks:
    docker:
      - image: appliedblockchain/libsnark-env
    steps:
      - checkout
      - run:
          name: Get ethsnarks
          command: git submodule update --init --recursive ethsnarks
      - run:
          name: CMake
          command: |
            cd ethsnarks
            mkdir build
            cd build
            cmake ..
      - run:
          name: make
          command: |
            cd ethsnarks/build
            make

  simple_example_jsnark:
    docker:
      - image: circleci/openjdk:8-jdk-browsers
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Run Java program
          command: java -cp bin examples.generators.SimpleCircuitGenerator

workflows:
  version: 2
  main:
    jobs:
      - build_jsnark_circuit_builder
      - build_jsnark_libsnark
      - build_ethsnarks
      - simple_example_jsnark:
          requires:
            - build_jsnark_circuit_builder
            - build_jsnark_libsnark
            - build_ethsnarks
